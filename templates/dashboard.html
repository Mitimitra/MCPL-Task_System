<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Task Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
        *{
            font-family: 'Poppins',sans-serif;
        }
        body {
            padding-top: 56px;
        }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Task Management</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown"
                aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="{{url_for("dashboard")}}">Dashboard</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownProfile"
                       role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Tasks Management
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownProfile">
                        <li>
                            <a class="dropdown-item" href="{{url_for("project_history")}}">Project History / Tasks Performed</a>
                        </li>
                        <li><a class="dropdown-item" href="{{url_for("tasks_assigned")}}">Tasks Assigned</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="{{ url_for("dashboard") }}" id="navbarDropdownProfile"
                       role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Reports Management
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownProfile">
                        <li><a class="dropdown-item" href="{{url_for("project_history_report")}}">Project History Report</a></li>
                            <li>
                                <a class="dropdown-item" href="{{url_for("tasks_performed_report")}}">Task Reports</a>
                            </li>
                    </ul>
                    
                </li>
            </ul>

            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownProfile"
                       role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Profile
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownProfile">
                        <li><a class="dropdown-item" href="#">Change Password</a></li>
                        <li><a class="dropdown-item" href="#">Account Settings</a></li>
                        {% if 'emp_name' in session %}
                        <li><a class="dropdown-item" href="{{ url_for("logout") }}">Logout</a></li>
                        {% endif %}
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Page Content -->
<div class="container mt-4">
    <h2>Welcome to the Dashboard. {{session["emp_name"]}} {{session["designation"]}} ({{session["user_category"]}}).</h2>
    <p>Select a menu option from above to begin.</p>

    {% if tasks_under_review %}
    <h2>Tasks Under Review</h2>
    <table class="table">
        <thead>
            <tr>
                <th>Sr.No</th>
                <th>Assigned To</th>
                <th>Project Details</th>
                <th>Task Description</th>
                <th>Remarks</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
            <tbody>
                {% for task in tasks_under_review %}
                <tr>
                    <td>{{ task.SrNo }}</td>
                    <td>{{ task.assigned_to }}</td>
                    <td style="width: 20%;">{{ task.project_details }}</td>
                    <td style="width: 40%;" ><textarea type="text" id="task_description_{{ task.SrNo }}" class="form-control" readonly disabled>{{ task.task_description }}</textarea></td>
                    <td style="width: 20%;" ><input type="text" class="form-control" value="{{ task.remarks }}" disabled id="remarks_{{ task.SrNo }}"></td>
                    <td style="width: 20%;">
                        <select name="task_status" id="status_{{ task.SrNo }}" class="form-select">
                            <option value="Cleared" {% if task.status == "Cleared" %} selected {% endif %} disabled id="Cleared">Cleared</option>
                            <option value="Pending" {% if task.status == "Pending" %} selected {% endif %}disabled id="Pending">Pending</option>
                            <option value="Reloaded" {% if task.status == "Reloaded" %} selected {% endif %} disabled id="Reloaded">Reloaded</option>
                            <option value="NA" {% if task.status == "NA" %} selected {% endif %} disabled id="NA">NA</option>
                        </select>
                    </td>
                    <td><input data-bs-toggle="modal" data-bs-target="#staticBackdrop" type="button" value="Edit" class="btn btn-outline-primary" id="edit_{{ task.SrNo }}" onclick="openReviewModal('{{ task.SrNo }}')"></td>
                </tr>
                {% endfor %}
            </tbody>
        </thead>
    </table>
    {% endif %}

    {% if complied_review_tasks %}
    <h2>Tasks Assigned</h2>
    <table class="table">
        <thead>
            <tr>
                <th>Sr.No</th>
                <th>Project Details</th>
                <th>Task Description</th>
                <th>Remarks</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
            <tbody>
                {% for task in complied_review_tasks %}
                <tr>
                    <td>{{ task.SrNo }}</td>
                    <td style="width: 30%;">{{ task.project_details }}</td>
                    <td ><textarea class="form-control" disabled id="task_description_{{ task.SrNo }}">{{task.task_description}}</textarea></td>
                    <td style="width: 15%;"  ><input type="text" class="form-control" value="{{ task.remarks }}" disabled id="remarks_{{ task.SrNo }}"></td>
                    <td style="width: 10%;">
                        <select name="task_status" id="status_{{ task.SrNo }}" class="form-select" disabled>
                            <option value="Cleared" selected disabled id="Pending">Cleared</option>
                            <option value="Reloaded" selected disabled id="Pending">Reloaded</option>
                            <option value="Pending" selected disabled id="Pending">Pending</option>
                        </select>
                    </td>
                    <td><input type="button" class="btn btn-outline-primary" value="Edit" onclick="openTaskModal('{{ task.SrNo }}')"><input type="button" value="Save" id="save_{{ task.SrNo }}" class="btn btn-outline-success" onclick="saveStatus('{{task.SrNo}}')"></td>
                </tr>
                {% endfor %}
            </tbody>
        </thead>
    </table>
    {% endif %}

    <!-- Modal -->
    <!-- Modal -->
<div class="modal fade" id="taskUpdateModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="taskUpdateModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="taskUpdateModalLabel">Update Task</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label for="taskUpdateText" class="form-label">Enter Task Updates</label>
          <textarea class="form-control" id="taskUpdateText" rows="3" required></textarea>
        </div>
        <div class="mb-3">
          <label for="taskRemarks" class="form-label">Remarks</label>
          <input type="text" class="form-control" id="taskRemarks" required>
        </div>
        <input type="hidden" id="modal_task_id">
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitTaskUpdate()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="reviewUpdateModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="taskUpdateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="reviewUpdateModalLabel">Update Task</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body" style="overflow: scroll;">
        <div class="mb-3">
          <label for="reviewUpdateText" class="form-label">Enter Task Updates</label>
          <textarea class="form-control" id="reviewUpdateText" rows="3" required></textarea>
        </div>
        <div class="mb-3">
          <label for="status_update" class="form-label">Update Status</label>
          <select name="status_update" id="status_update" class="form-select">
            <option value="Update Task Status" selected>Update Task Status</option>
            <option value="Cleared">Cleared</option>
            <option value="Pending">Pending</option>
            <option value="Reloaded">Reloaded</option>
            <option value="NA">NA</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="reviewRemarks" class="form-label">Remarks</label>
          <input type="text" class="form-control" id="reviewRemarks" required>
        </div>
        <input type="hidden" id="modal_task_id">
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitReviewUpdate()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

    </div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
function openTaskModal(taskId) {
    // Store the task ID in the hidden field
    document.getElementById("modal_task_id").value = taskId;

    // Optionally, prefill description and remarks
    const taskDescElement = document.getElementById("task_description_" + taskId);
    const remarksElement = document.getElementById("remarks_" + taskId);

    document.getElementById("taskUpdateText").placeholder = taskDescElement ? taskDescElement.value || taskDescElement.innerText : '';
    document.getElementById("taskRemarks").placeholder = remarksElement ? remarksElement.value || remarksElement.innerText : '';

    // Show the modal
    const myModal = new bootstrap.Modal(document.getElementById('taskUpdateModal'));
    myModal.show();
}

function submitTaskUpdate() {
    const taskId = document.getElementById("modal_task_id").value;
    const taskDesc = document.getElementById("taskUpdateText").value;
    const remarks = document.getElementById("taskRemarks").value;

    fetch("/update_assigned_tasks", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            task_id: taskId,
            task_desc: taskDesc,
            remarks: remarks
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === '200') {
            alert(data.message);

            // Optionally refresh or update UI
            location.reload(); // reload to reflect changes
        } else {
            alert("Update failed.");
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Something went wrong!");
    });
}
</script>

<script>
function openReviewModal(taskId) {
    // Store the task ID in the hidden field
    document.getElementById("modal_task_id").value = taskId;

    // Optionally, prefill description and remarks
    const taskDescElement = document.getElementById("task_description_" + taskId);
    const remarksElement = document.getElementById("remarks_" + taskId);

    console.log(taskDescElement);
    console.log(remarksElement);

    document.getElementById("reviewUpdateText").placeholder = taskDescElement ? taskDescElement.value || taskDescElement.innerText : '';
    document.getElementById("reviewRemarks").placeholder = remarksElement ? remarksElement.value || remarksElement.innerText : '';

    // Show the modal
    const myModal = new bootstrap.Modal(document.getElementById('reviewUpdateModal'));
    myModal.show();
}

function submitReviewUpdate() {
    const taskId = document.getElementById("modal_task_id").value;
    const taskDesc = document.getElementById("reviewUpdateText").value;
    let remarks = document.getElementById("reviewRemarks").value;
    const status = document.getElementById("status_update").value;

    remarks = remarks+" (Edit): "+". Task Has Been "+status;

    fetch("/update_task_under_review", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            task_id: taskId,
            task_desc: taskDesc,
            remarks: remarks,
            task_status : status
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === '200') {
            alert(data.message);

            // Optionally refresh or update UI
            location.reload(); // reload to reflect changes
        } else {
            alert("Update failed.");
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Something went wrong!");
    });
}
</script>

<script>
            function editRecord(task_id) {
                //$('#task_description_'+task_id).removeAttr('disabled');
                const task_desc = document.getElementById('task_description_'+task_id)
                

                task_desc.attributes.disabled = false;
                console.log(task_desc);
                task_desc.removeAttribute('disabled');

                console.log(task_desc)

                //document.getElementById("task_description_" + task_id).ariaReadOnly = false;
                document.getElementById("remarks_" + task_id).disabled = false;
                document.getElementById("save_" + task_id).style.display = "inline-block";
                //document.getElementById("edit_" + task_id).style.display = "none";
            }

            function saveStatus(task_id) {
                let new_task_description = document.getElementById('task_description_'+task_id).value;
                let new_remarks = document.getElementById('remarks_'+task_id).value;
                let status = document.getElementById('status_'+task_id).value;

                fetch("/update_assigned_tasks", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        task_id: task_id,
                        task_desc: new_task_description,
                        remarks: new_remarks
                        //status: status
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        alert(data.message);
                        document.getElementById("remarks_" + task_id).innerText = data.updated_remarks;
                        document.getElementById("status_" + task_id).disabled = true;
                        document.getElementById("save_" + task_id).style.display = "none";
                        document.getElementById("edit_" + task_id).style.display = "inline-block";
                    } else {
                        alert("Error: " + data.error);
                    }
                })
                .catch(error => console.error("Error:", error));
            }
</script>
</body>
</html>
