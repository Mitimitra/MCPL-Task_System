<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Task Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
        *{
            font-family: 'Poppins',sans-serif;
        }
        body {
            padding-top: 56px;
        }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Task Management</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown"
                aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="{{url_for("dashboard")}}">Dashboard</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownProfile"
                       role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Tasks Management
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownProfile">
                        <li>
                            <a class="dropdown-item" href="{{url_for("project_history")}}">Project History / Tasks Performed</a>
                        </li>
                        <li><a class="dropdown-item" href="{{url_for("tasks_assigned")}}">Tasks Assigned</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="{{ url_for("dashboard") }}" id="navbarDropdownProfile"
                       role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Reports Management
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownProfile">
                        <li><a class="dropdown-item" href="{{url_for("project_history_report")}}">Project History Report</a></li>
                            <li>
                                <a class="dropdown-item" href="{{url_for("tasks_performed_report")}}">Task Reports</a>
                            </li>
                    </ul>
                    
                </li>
                {% if session['user_category'] == 'SuperAdmin' %}
                    <li class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" id="navbarDropdownProfile" role="button" 
                        data-bs-toggle="dropdown" aria-expanded="false">Admin Panel</a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownProfile">
                            <li><a href="#" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#addProjectModal">Add a Project</a></li>
                            <li><a href="#" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">Add an Employee</a></li>
                        </ul>
                    </li>
                {% endif %}
            </ul>

            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownProfile"
                       role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Profile
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownProfile">
                        <li><a class="dropdown-item" href="#">Change Password</a></li>
                        <li><a class="dropdown-item" href="#">Account Settings</a></li>
                        {% if 'emp_name' in session %}
                        <li><a class="dropdown-item" href="{{ url_for("logout") }}">Logout</a></li>
                        {% endif %}
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Page Content -->
<div class="container mt-4">
    <h2>Welcome to the Dashboard. {{session["emp_name"]}} {{session["designation"]}} ({{session["user_category"]}}).</h2>
    <p>Select a menu option from above to begin.</p>

    {% if tasks_under_review %}
    <h2>Tasks Under Review</h2>
    <table class="table">
        <thead>
            <tr>
                <th>Sr.No</th>
                <th>Assigned To</th>
                <th>Project Details</th>
                <th>Task Description</th>
                <th>Remarks</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
            <tbody>
                {% for task in tasks_under_review %}
                <tr>
                    <td>{{ task.SrNo }}</td>
                    <td>{{ task.assigned_to }}</td>
                    <td style="width: 20%;">{{ task.project_details }}</td>
                    <td style="width: 40%;" ><textarea type="text" id="task_description_{{ task.SrNo }}" class="form-control" readonly disabled>{{ task.task_description }}</textarea></td>
                    <td style="width: 20%;" ><input type="text" class="form-control" value="{{ task.remarks }}" disabled id="remarks_{{ task.SrNo }}"></td>
                    <td style="width: 20%;">
                        <select name="task_status" id="status_{{ task.SrNo }}" class="form-select">
                            <option value="Cleared" {% if task.status == "Cleared" %} selected {% endif %} disabled id="Cleared">Cleared</option>
                            <option value="Pending" {% if task.status == "Pending" %} selected {% endif %}disabled id="Pending">Pending</option>
                            <option value="Reloaded" {% if task.status == "Reloaded" %} selected {% endif %} disabled id="Reloaded">Reloaded</option>
                            <option value="NA" {% if task.status == "NA" %} selected {% endif %} disabled id="NA">NA</option>
                        </select>
                    </td>
                    <td><input data-bs-toggle="modal" data-bs-target="#staticBackdrop" type="button" value="Edit" class="btn btn-outline-primary" id="edit_{{ task.SrNo }}" onclick="openReviewModal('{{ task.SrNo }}')"></td>
                </tr>
                {% endfor %}
            </tbody>
        </thead>
    </table>
    {% endif %}

    {% if assigned_tasks %}
    <h2>Tasks Assigned</h2>
    <table class="table">
        <thead>
            <tr>
                <th>Sr.No</th>
                <th>Assigned By</th>
                <th>Project Details</th>
                <th>Task Description</th>
                <th>Remarks</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
            <tbody>
                {% for task in assigned_tasks %}
                <tr>
                    <td>{{ task.SrNo }}</td>
                    <td>{{ task.assigned_to }}</td>
                    <td style="width: 30%;">{{ task.project_details }}</td>
                    <td ><textarea class="form-control" disabled id="task_description_{{ task.SrNo }}">{{task.task_description}}</textarea></td>
                    <td style="width: 15%;"  ><input type="text" class="form-control" value="{{ task.remarks }}" disabled id="remarks_{{ task.SrNo }}"></td>
                    <td style="width: 10%;">
                        <select name="task_status" id="status_{{ task.SrNo }}" class="form-select" disabled>
                            <option value="Cleared" selected disabled id="Pending">Cleared</option>
                            <option value="Reloaded" selected disabled id="Pending">Reloaded</option>
                            <option value="Pending" selected disabled id="Pending">Pending</option>
                        </select>
                    </td>
                    <td><input type="button" class="btn btn-outline-primary" value="Edit" onclick="openTaskModal('{{ task.SrNo }}')"><input type="button" value="Save" id="save_{{ task.SrNo }}" class="btn btn-outline-success" onclick="saveStatus('{{task.SrNo}}')"></td>
                </tr>
                {% endfor %}
            </tbody>
        </thead>
    </table>
    {% endif %}

    <!-- Modal -->
    <!-- Modal -->
<div class="modal fade" id="taskUpdateModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="taskUpdateModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="taskUpdateModalLabel">Update Task</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label for="taskUpdateText" class="form-label">Enter Task Updates</label>
          <textarea class="form-control" id="taskUpdateText" rows="3" required></textarea>
        </div>
        <div class="mb-3">
          <label for="taskRemarks" class="form-label">Remarks</label>
          <input type="text" class="form-control" id="taskRemarks" required>
        </div>
        <input type="hidden" id="modal_task_id">
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitTaskUpdate()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="reviewUpdateModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="taskUpdateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="reviewUpdateModalLabel">Update Task</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body" style="overflow: scroll;">
        <div class="mb-3">
          <label for="reviewUpdateText" class="form-label">Enter Task Updates</label>
          <textarea class="form-control" id="reviewUpdateText" rows="3" required></textarea>
        </div>
        <div class="mb-3">
          <label for="status_update" class="form-label">Update Status</label>
          <select name="status_update" id="status_update" class="form-select">
            <option value="Update Task Status" selected>Update Task Status</option>
            <option value="Cleared">Cleared</option>
            <option value="Pending">Pending</option>
            <option value="Reloaded">Reloaded</option>
            <option value="NA">NA</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="reviewRemarks" class="form-label">Remarks</label>
          <input type="text" class="form-control" id="reviewRemarks" required>
        </div>
        <input type="hidden" id="modal_task_id">
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitReviewUpdate()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

    <!-- Admin Modals -->

        <!-- Admin Modals -->
    <!-- Add Project Modal -->
    <div class="modal fade" id="addProjectModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="addProjectModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="addProjectModalLabel">Add a Project</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <form id="addProjectForm">
              <div class="mb-3">
                <label for="projectCode" class="form-label">Project Code</label>
                <input type="text" class="form-control" id="projectCode" required>
              </div>
              <div class="mb-3">
                <label for="projectName" class="form-label">Project Name</label>
                <input type="text" class="form-control" id="projectName" required>
              </div>
              <div class="mb-3">
                <label for="clientName" class="form-label">Client Name</label>
                <input type="text" class="form-control" id="clientName">
              </div>
              <div class="mb-3">
                <label for="clientAddr" class="form-label">Client Address</label>
                <input type="text" class="form-control" id="clientAddr">
              </div>
              <div class="mb-3">
                <label for="clientContactInfo" class="form-label">Client Contact Info</label>
                <input type="text" class="form-control" id="clientContactInfo">
              </div>
              <div class="mb-3">
                <label for="remarks" class="form-label">Remarks</label>
                <input type="text" class="form-control" id="remarks">
              </div>
            </form>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary" form="addProjectForm">Save Project</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Employee Modal -->
    <div class="modal fade" id="addEmployeeModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="addEmployeeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="addEmployeeModalLabel">Add an Employee</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <form id="addEmployeeForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="empName" class="form-label">Employee Name</label>
              <input type="text" class="form-control" id="empName" required>
            </div>

            <div class="col-md-6 mb-3">
              <label for="empEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="empEmail" required>
            </div>

            <div class="col-md-6 mb-3">
              <label for="empDesignation" class="form-label">Designation Code</label>
              <select class="form-select" id="empDesignation" required onchange="updateDesigName()">
                <option value="">-- Select Designation --</option>
                {% for desig in designations %}
                <option value="{{desig.desig_id}}" data-name="{{desig.desig_name}}">{{desig.desig_code}}</option>
                {% endfor %}
              </select>
            </div>

            <script>
                function updateDesigName(){
                    const select = document.getElementById("empDesignation");
                    const selectedOption = select.options[select.selectedIndex];
                    const desigName = selectedOption.getAttribute("data-name");

                    document.getElementById("empDesignationName").value = desigName || "";
                }
            </script>

            <div class="col-md-6 mb-3">
                <label for="empDesignationName" class="form-label">Designation Name</label>
              <input type="text" class="form-control" id="empDesignationName" disabled>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="empDOB" class="form-label">Date of Birth</label>
              <input type="date" id="empDOB" class="form-control" placeholder="Select DOB">
            </div>
            <div class="col-md-6 mb-3">
              <label for="empDOJ" class="form-label">Date of Joining</label>
              <input type="date" id="empDOJ" class="form-control" placeholder="Select DOJ">
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="empBranch" class="form-label">Branch</label>
              <select class="form-select" id="empBranch" required onchange="updateBranchName()">
                <option value="">-- Select Branch --</option>
                {% for branch in branches %}
                <option value="{{branch.branch_id}}" data-name="{{branch.branch_name}}">{{branch.branch_code}}</option>
                {% endfor %}
              </select>
            </div>

            <script>
                function updateBranchName(){
                    const select = document.getElementById("empBranch");
                    const selectedOption = select.options[select.selectedIndex];
                    const branchName = selectedOption.getAttribute("data-name");

                    document.getElementById("empBranchName").value = branchName || "";
                }
            </script>


            <div class="col-md-6 mb-3">

                <label for="empBranchName" class="form-label">Branch Name</label>
                <input type="text" class="form-control" id="empBranchName" disabled>

            </div>

          </div>

          <div class="mb-3">
            <label for="empUsername" class="form-label">Username</label>
            <input type="text" class="form-control" id="empUsername" required>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary" form="addEmployeeForm">Save Employee</button>
      </div>
    </div>
  </div>
</div>



    </div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
function openTaskModal(taskId) {
    // Store the task ID in the hidden field
    document.getElementById("modal_task_id").value = taskId;

    // Optionally, prefill description and remarks
    const taskDescElement = document.getElementById("task_description_" + taskId);
    const remarksElement = document.getElementById("remarks_" + taskId);

    document.getElementById("taskUpdateText").placeholder = taskDescElement ? taskDescElement.value || taskDescElement.innerText : '';
    document.getElementById("taskRemarks").placeholder = remarksElement ? remarksElement.value || remarksElement.innerText : '';

    // Show the modal
    const myModal = new bootstrap.Modal(document.getElementById('taskUpdateModal'));
    myModal.show();
}

function submitTaskUpdate() {
    const taskId = document.getElementById("modal_task_id").value;
    const taskDesc = document.getElementById("taskUpdateText").value;
    const remarks = document.getElementById("taskRemarks").value;

    fetch("/update_assigned_tasks", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            task_id: taskId,
            task_desc: taskDesc,
            remarks: remarks
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === '200') {
            alert(data.message);

            // Optionally refresh or update UI
            location.reload(); // reload to reflect changes
        } else {
            alert("Update failed.");
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Something went wrong!");
    });
}
</script>

<script>
function openReviewModal(taskId) {
    // Store the task ID in the hidden field
    document.getElementById("modal_task_id").value = taskId;

    // Optionally, prefill description and remarks
    const taskDescElement = document.getElementById("task_description_" + taskId);
    const remarksElement = document.getElementById("remarks_" + taskId);

    console.log(taskDescElement);
    console.log(remarksElement);

    document.getElementById("reviewUpdateText").placeholder = taskDescElement ? taskDescElement.value || taskDescElement.innerText : '';
    document.getElementById("reviewRemarks").placeholder = remarksElement ? remarksElement.value || remarksElement.innerText : '';

    // Show the modal
    const myModal = new bootstrap.Modal(document.getElementById('reviewUpdateModal'));
    myModal.show();
}

function submitReviewUpdate() {
    const taskId = document.getElementById("modal_task_id").value;
    const taskDesc = document.getElementById("reviewUpdateText").value;
    let remarks = document.getElementById("reviewRemarks").value;
    const status = document.getElementById("status_update").value;

    remarks = remarks+" (Edit): "+". Task Has Been "+status;

    fetch("/update_task_under_review", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            task_id: taskId,
            task_desc: taskDesc,
            remarks: remarks,
            task_status : status
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === '200') {
            alert(data.message);

            // Optionally refresh or update UI
            location.reload(); // reload to reflect changes
        } else {
            alert("Update failed.");
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Something went wrong!");
    });
}
</script>

<!-- Admin Panel Modals Script -->
<script>
    document.addEventListener("DOMContentLoaded", function(){
        document.getElementById("addProjectForm").addEventListener("submit", function(e) {
        e.preventDefault();

        const projectCode = document.getElementById("projectCode").value;
        const clientName = document.getElementById("clientName").value;
        const clientAddr = document.getElementById("clientAddr").value;
        const clientContactInfo = document.getElementById("clientContactInfo").value;
        const remarks = document.getElementById("remarks").value;
        const projectName = document.getElementById("projectName").value;
        

        fetch("/add_project", {
            headers: {"Content-Type":"application/json"},
            method: "POST",
            body: JSON.stringify({
                project_code : projectCode,
                project_name : projectName,
                clientName : clientName,
                clientAddr : clientAddr,
                clientContactInfo : clientContactInfo,
                remarks : remarks
            })
        }).then((res) => res.json())
        .then((data) => {
            alert(data.message || "Project Saved Successfully..")
            if(data.status === 200){
                location.reload();
            }
        }).catch((err) =>{
            console.error(err)
            alert("Something went wrong during saving the project.")
        })


    })

    });

</script>
<!-- Employee Addition Script -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("addEmployeeForm").addEventListener("submit", function (e) {
        e.preventDefault();

        // Collect values
        const empName = document.getElementById("empName").value;
        const empEmail = document.getElementById("empEmail").value;
        const empDesignation = document.getElementById("empDesignation").value; // desig_id
        const empDesignationName = document.getElementById("empDesignationName").value;
        const empBranch = document.getElementById("empBranch").value; // branch_id
        const empBranchName = document.getElementById("empBranchName").value;
        const empUsername = document.getElementById("empUsername").value;
        const emp_dob = document.getElementById("empDOB").value;
        const emp_doj = document.getElementById("empDOJ").value;

        // Prepare payload
        const formData = {
            name: empName,
            email: empEmail,
            designation_id: empDesignation,
            designation_name: empDesignationName,
            branch_id: empBranch,
            branch_name: empBranchName,
            username: empUsername,
            empDOB : emp_dob,
            empDOJ : emp_doj
        };

        console.log("Form Data:", formData); // Debugging

        // Example: Send to backend (adjust URL to your route)
        fetch("/add_employee", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}" // if you're using Django/Flask-WTF, else remove
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            console.log("Server Response:", data);
            alert("Employee saved successfully!");
            // Optionally reset form
            document.getElementById("addEmployeeForm").reset();
            document.getElementById("empDesignationName").value = "";
            document.getElementById("empBranchName").value = "";
        })
        .catch(error => {
            console.error("Error:", error);
            alert("Failed to save employee.");
        });
    });
});
</script>


<script>
            function editRecord(task_id) {
                //$('#task_description_'+task_id).removeAttr('disabled');
                const task_desc = document.getElementById('task_description_'+task_id)
                

                task_desc.attributes.disabled = false;
                console.log(task_desc);
                task_desc.removeAttribute('disabled');

                console.log(task_desc)

                //document.getElementById("task_description_" + task_id).ariaReadOnly = false;
                document.getElementById("remarks_" + task_id).disabled = false;
                document.getElementById("save_" + task_id).style.display = "inline-block";
                //document.getElementById("edit_" + task_id).style.display = "none";
            }

            function saveStatus(task_id) {
                let new_task_description = document.getElementById('task_description_'+task_id).value;
                let new_remarks = document.getElementById('remarks_'+task_id).value;
                let status = document.getElementById('status_'+task_id).value;

                fetch("/update_assigned_tasks", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        task_id: task_id,
                        task_desc: new_task_description,
                        remarks: new_remarks
                        //status: status
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        alert(data.message);
                        document.getElementById("remarks_" + task_id).innerText = data.updated_remarks;
                        document.getElementById("status_" + task_id).disabled = true;
                        document.getElementById("save_" + task_id).style.display = "none";
                        document.getElementById("edit_" + task_id).style.display = "inline-block";
                    } else {
                        alert("Error: " + data.error);
                    }
                })
                .catch(error => console.error("Error:", error));
            }
</script>
</body>
</html>
