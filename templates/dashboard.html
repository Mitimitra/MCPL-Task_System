<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Task Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
        *{
            font-family: 'Poppins',sans-serif;
        }
        body {
            padding-top: 56px;
        }
    </style>
    <script>
function applyReviewFilters() {
  const assignedTo = document.getElementById("filterAssignedTo").value.toLowerCase();
  //const deadline = document.getElementById("filterDeadlineReview").value;
  //const projectCode = document.getElementById("filterProjectReview").value.toLowerCase();

  const table = document.getElementById("tasksUnderReviewTable");
  const rows = table.getElementsByTagName("tr");

  for (let i = 1; i < rows.length; i++) {
    let show = true;
    const cols = rows[i].getElementsByTagName("td");

    const colAssignedTo = cols[2]?.innerText.toLowerCase();
    //const colProjectCode = cols[3]?.innerText.toLowerCase();
    //const colDeadline = cols[5]?.innerText;

    if (assignedTo && colAssignedTo !== assignedTo) show = false;
    //if (projectCode && !colProjectCode.includes(projectCode)) show = false;
    //if (deadline && colDeadline !== deadline) show = false;

    rows[i].style.display = show ? "" : "none";
  }
}
</script>


</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Task Management</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown"
                aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="{{url_for("dashboard")}}">Dashboard</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownProfile"
                       role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Tasks Management
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownProfile">
                        <li>
                            <a class="dropdown-item" href="{{url_for("project_history")}}">Project History / Tasks Performed</a>
                        </li>
                        <li><a class="dropdown-item" href="{{url_for("tasks_assigned")}}">Tasks Assigned</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="{{ url_for("dashboard") }}" id="navbarDropdownProfile"
                       role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Reports Management
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownProfile">
                        <li><a class="dropdown-item" href="{{url_for("project_history_report")}}">Project History Report</a></li>
                            <li>
                                <a class="dropdown-item" href="{{url_for("tasks_performed_report")}}">Task Reports</a>
                            </li>
                    </ul>
                    
                </li>
                {% if session['user_category'] == 'SuperAdmin' %}
                    <li class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" id="navbarDropdownProfile" role="button" 
                        data-bs-toggle="dropdown" aria-expanded="false">Admin Panel</a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownProfile">
                            <li><a href="#" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#addProjectModal">Add a Project</a></li>
                            <li><a href="#" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">Add an Employee</a></li>
                            <li><a href="#" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#assignProjectToEmployeeModal">Assign Project to Employee</a></li>

                        </ul>
                    </li>
                {% endif %}
                {% if session['user_category'] == 'SuperAdmin' or session['user_category'] == 'Admin' %}
                <li class="nav-item">
                  <a href="{{ url_for("director_meetings") }}" class="nav-link">Director Meetings</a>
                </li>
                {% endif %}
                {% if session['user_category'] == 'SuperAdmin' %}
                <li class="nav-item"><a href="" class="nav-link" data-bs-toggle="modal" data-bs-target="#employeeListModal">Employee List</a></li>
                {% endif %}
            </ul>

            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownProfile"
                       role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Profile
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownProfile">
                        <li><a class="dropdown-item" href="#" onclick="openPasswordModal()">Change Password</a></li>
                        <li><a class="dropdown-item" href="#">Account Settings</a></li>
                        {% if 'emp_name' in session %}
                        <li><a class="dropdown-item" href="{{ url_for("logout") }}">Logout</a></li>
                        {% endif %}
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Page Content -->
<div class="container mt-4">
    <h2>Welcome to the Dashboard. {{session["emp_name"]}} {{session["designation"]}} ({{session["user_category"]}}).</h2>
    <p>Select a menu option from above to begin.</p>

    {% if tasks_under_review %}
    <h2>Tasks Under Review</h2>

<!-- Filters -->
<!-- Filters -->
<div class="row mb-3">
  <div class="col-md-3">
    <label for="filterAssignedTo" class="form-label">Assigned To</label>
    <select id="filterAssignedTo" class="form-select">
      <option value="">All</option>
      {% for name in filtered_name %}
        <option value="{{name.name}}">{{name.name}}</option>
      {% endfor %}
    </select>
  </div>

  <!-- <div class="col-md-3">
    <label for="filterDeadlineReview" class="form-label">Deadline</label>
    <select id="filterDeadlineReview" class="form-select">
      <option value="">All</option>
      {% for name in filtered_name %}
        <option value="{{name.target_date}}">{{name.target_date}}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <label for="filterProjectReview" class="form-label">Project Code</label>
    <select id="filterProjectReview" class="form-select">
      <option value="">All</option>
      {% for name in filtered_name %}
        <option value="{{name.project_code}}">{{name.project_code}}</option>
      {% endfor %}
    </select>
  </div> -->

  <div class="col-md-3 d-flex align-items-end">
    <button class="btn btn-primary w-100" onclick="applyReviewFilters()">Apply Filters</button>
  </div>
</div>


    <table class="table" id="tasksUnderReviewTable">
        <thead>
            <tr>
                <th>Sr.No</th>
                <th>Assigned Date</th>
                <th>Assigned To</th>
                <th>Project Details</th>
                <th>Task Description</th>
                <th>Deadline</th>
                <th>Remarks</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
            <tbody>
                {% for task in tasks_under_review %}
                <tr>
                    <td>{{ task.SrNo }}</td>
                    <td style="width: 10%;">{{ task.date_of_entry }}</td>
                    <td>{{ task.assigned_to }}</td>
                    <td style="width: 20%;">{{ task.project_details }}</td>
                    <td style="width: 35%;" ><textarea type="text" id="task_description_{{ task.SrNo }}" class="form-control" readonly disabled>{{ task.task_description }}</textarea></td>
                    <td style="width: 10%;">{{task.target_date}}</td>
                    <td style="width: 10%;" ><textarea class="form-control" disabled id="remarks_{{ task.SrNo }}">{{task.remarks}}</textarea></td></td>
                    <td style="width: 20%;">
                        <select name="task_status" id="status_{{ task.SrNo }}" class="form-select">
                            <option value="Cleared" {% if task.status == "Cleared" %} selected {% endif %} disabled id="Cleared">Cleared</option>
                            <option value="Pending" {% if task.status == "Pending" %} selected {% endif %}disabled id="Pending">Pending</option>
                            <option value="Reloaded" {% if task.status == "Reloaded" %} selected {% endif %} disabled id="Reloaded">Reloaded</option>
                            <option value="NA" {% if task.status == "NA" %} selected {% endif %} disabled id="NA">NA</option>
                        </select>
                    </td>
                    <td><input data-bs-toggle="modal" data-bs-target="#staticBackdrop" type="button" value="Edit" class="btn btn-outline-primary" id="edit_{{ task.SrNo }}" onclick="openReviewModal('{{ task.SrNo }}')"></td>
                </tr>
                {% endfor %}
            </tbody>
        </thead>
    </table>
    {% endif %}

    {% if assigned_tasks %}
<h2>Tasks Assigned</h2>

<!-- Filters -->
<div class="row mb-3">
  <div class="col-md-3">
    <label for="filterAssignedBy" class="form-label">Assigned By</label>
    <select id="filterAssignedBy" class="form-select">
      <option value="">All</option>
      {% for name in assigned_tasks_filter_name %}
        <option value="{{name.name}}">{{name.name}}</option>
      {% endfor %}
    </select>
  </div>

  <!-- <div class="col-md-3">
    <label for="filterDeadlineAssigned" class="form-label">Deadline</label>
    <select id="filterDeadlineAssigned" class="form-select">
      <option value="">All</option>
      {% for task in assigned_tasks %}
        <option value="{{task.target_date}}">{{task.target_date}}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <label for="filterProjectAssigned" class="form-label">Project Code</label>
    <select id="filterProjectAssigned" class="form-select">
      <option value="">All</option>
      {% for task in assigned_tasks %}
        <option value="{{task.project_details.split(':')[0]}}">{{task.project_details.split(':')[0]}}</option>
      {% endfor %}
    </select>
  </div> -->

  <div class="col-md-3 d-flex align-items-end">
    <button class="btn btn-primary w-100" onclick="applyAssignedFilters()">Apply Filters</button>
  </div>
</div>


<table class="table" id="tasksAssignedTable">
  <thead>
    <tr>
      <th>Sr.No</th>
      <th>Assigned By</th>
      <th>Project Details</th>
      <th>Task Description</th>
      <th>Assigned Date</th>
      <th>Deadline</th>
      <th>Remarks</th>
      <th>Status</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    {% for task in assigned_tasks %}
    <tr>
      <td>{{ task.SrNo }}</td>
      <td style="width: 10%;">{{ task.assigned_to }}</td>
      <td style="width: 20%;">{{ task.project_details }}</td>
      <td style="width: 25%;"><textarea class="form-control" disabled id="task_description_{{ task.SrNo }}">{{task.task_description}}</textarea></td>
      <td style="width: 10%;">{{task.date_of_entry}}</td>
      <td style="width: 10%;">{{task.target_date}}</td>
      <td style="width: 10%;"><textarea class="form-control" disabled id="remarks_{{ task.SrNo }}">{{task.remarks}}</textarea></td>
      <td style="width: 10%;">
        <select name="task_status" id="status_{{ task.SrNo }}" class="form-select" disabled>
          <option value="Cleared" {% if task.status == "Cleared" %}selected{% endif %}>Cleared</option>
          <option value="Reloaded" {% if task.status == "Reloaded" %}selected{% endif %}>Reloaded</option>
          <option value="Pending" {% if task.status == "Pending" %}selected{% endif %}>Pending</option>
        </select>
      </td>
      <td>
        <input type="button" class="btn btn-outline-primary" value="Edit" onclick="openTaskModal('{{ task.SrNo }}')">
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}

<script>
function applyAssignedFilters() {
  const assignedBy = document.getElementById("filterAssignedBy").value.toLowerCase();
  //const deadline = document.getElementById("filterDeadlineAssigned").value;
  //const projectCode = document.getElementById("filterProjectAssigned").value.toLowerCase();

  const table = document.getElementById("tasksAssignedTable");
  const rows = table.getElementsByTagName("tr");

  for (let i = 1; i < rows.length; i++) {
    let show = true;
    const cols = rows[i].getElementsByTagName("td");

    const colAssignedBy = cols[1]?.innerText.toLowerCase();
    //const colProjectCode = cols[2]?.innerText.toLowerCase();
    //const colDeadline = cols[4]?.innerText;

    if (assignedBy && colAssignedBy !== assignedBy) show = false;
    //if (projectCode && !colProjectCode.includes(projectCode)) show = false;
    //if (deadline && colDeadline !== deadline) show = false;

    rows[i].style.display = show ? "" : "none";
  }
}
</script>




    <!-- Modal -->
    <!-- Modal -->
<div class="modal fade" id="taskUpdateModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="taskUpdateModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="taskUpdateModalLabel">Update Task</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label for="taskUpdateText" class="form-label" id="taskModalLabel1"></label>
          <textarea class="form-control" id="taskUpdateText" rows="3" required placeholder="Enter Task Updates"></textarea>
        </div>
        <div class="mb-3">
          <label for="taskRemarks" class="form-label" id="taskModalLabel2"></label>
          <input type="text" class="form-control" id="taskRemarks" placeholder="Enter Remarks Updates" required>
        </div>
        <input type="hidden" id="modal_task_id">
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitTaskUpdate()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="reviewUpdateModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="taskUpdateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="reviewUpdateModalLabel">Update Task</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body" style="overflow: scroll;">
        <div class="mb-3">
          <label for="reviewUpdateText" class="form-label" id="revieUpdateLabel">Enter Task Updates</label>
          <textarea class="form-control" id="reviewUpdateText" rows="3" required></textarea>
        </div>
        <div class="mb-3">
          <label for="status_update" class="form-label">Update Status</label>
          <select name="status_update" id="status_update" class="form-select">
            <option value="Update Task Status" selected>Update Task Status</option>
            <option value="Cleared">Cleared</option>
            <option value="Pending">Pending</option>
            <option value="Reloaded">Reloaded</option>
            <option value="NA">NA</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="reviewRemarks" class="form-label">Remarks</label>
          <input type="text" class="form-control" id="reviewRemarks" required>
        </div>
        <input type="hidden" id="modal_task_id">
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitReviewUpdate()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

  <!-- Change Password Modal -->
<div class="modal fade" id="passwordUpdateModal" tabindex="-1" aria-labelledby="passwordUpdateModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="passwordUpdateModalLabel">Change Password</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        

        <div class="mb-3">
          <label for="oldPassword" class="form-label">New Password</label>
          <input type="password" class="form-control" id="newPassword">
        </div>
        <div class="mb-3">
          <label for="newPassword" class="form-label">Confirm New Password</label>
          <input type="password" class="form-control" id="confnewPassword">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="submitPasswordUpdate()">Save</button>
      </div>
    </div>
  </div>
</div>


<script>
  function openPasswordModal(userId) {
    const modal = new bootstrap.Modal(document.getElementById("passwordUpdateModal"));
    modal.show();
  }

function submitPasswordUpdate() {
    const newPassword = document.getElementById("newPassword").value;
    const confnewPassword = document.getElementById("confnewPassword").value;

    if (newPassword === confnewPassword){
      fetch("/change_password", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ newPassword : newPassword })
    })
    .then(res => res.json())
    .then(data => {
        alert(data.message || "Password updated successfully");
        bootstrap.Modal.getInstance(document.getElementById("passwordUpdateModal")).hide();
    })
    .catch(err => console.error("Password update failed:", err));
    } else{
      alert("Passwords Do not Match")
    }
}
</script>


    <!-- Admin Modals -->

        <!-- Admin Modals -->
    <!-- Add Project Modal -->
    <div class="modal fade" id="addProjectModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="addProjectModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="addProjectModalLabel">Add a Project</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <form id="addProjectForm">
              <div class="mb-3">
                <label for="projectCode" class="form-label">Project Code</label>
                <input type="text" class="form-control" id="projectCode" required>
              </div>
              <div class="mb-3">
                <label for="projectName" class="form-label">Project Name</label>
                <input type="text" class="form-control" id="projectName" required>
              </div>
              <div class="mb-3">
                <label for="clientName" class="form-label">Client Name</label>
                <input type="text" class="form-control" id="clientName">
              </div>
              <div class="mb-3">
                <label for="clientAddr" class="form-label">Client Address</label>
                <input type="text" class="form-control" id="clientAddr">
              </div>
              <div class="mb-3">
                <label for="clientContactInfo" class="form-label">Client Contact Info</label>
                <input type="text" class="form-control" id="clientContactInfo">
              </div>
              <div class="mb-3">
                <label for="remarks" class="form-label">Remarks</label>
                <input type="text" class="form-control" id="remarks">
              </div>
            </form>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary" form="addProjectForm">Save Project</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Assign Employee to Project Modal -->
<!-- Assign Employee to Project Modal -->
<div class="modal fade" id="assignProjectToEmployeeModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="addProjectModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="addProjectModalLabel">Assign an Employee to Project</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <table class="table table-bordered table-striped align-middle">
          <thead>
            <tr>
              <th>Project</th>
              <th>Architect Assigned</th>
              <th>Engineer Assigned</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for project in projects %}
            <tr data-project-id="{{ project.id }}">
              <td>{{ project.proj_details }}</td>

              <!-- Architect dropdown -->
              <td>
                <select class="form-select arch-assigned" disabled>
                  <option value="">-- Select Architect --</option>
                  {% for user in users %}
                    <option value="{{ user.id }}" {% if project.archAssigned == user.id %}selected{% endif %}>
                      {{ user.name }}
                    </option>
                  {% endfor %}
                </select>
              </td>

              <!-- Engineer dropdown -->
              <td>
                <select class="form-select engr-assigned" disabled>
                  <option value="">-- Select Engineer --</option>
                  {% for user in users %}
                    <option value="{{ user.id }}" {% if project.engrAssigned == user.id %}selected{% endif %}>
                      {{ user.name }}
                    </option>
                  {% endfor %}
                </select>
              </td>

              <!-- Action Button -->
              <td>
                <button class="btn btn-sm btn-primary" onclick="toggleEdit(this)">Edit</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



<script>
function toggleEdit(button) {
  const row = button.closest("tr");
  const archDropdown = row.querySelector(".arch-assigned");
  const engrDropdown = row.querySelector(".engr-assigned");

  if (button.textContent === "Edit") {
    // Enable dropdowns
    archDropdown.disabled = false;
    engrDropdown.disabled = false;

    // Change button to Save
    button.textContent = "Save";
    button.classList.remove("btn-primary");
    button.classList.add("btn-success");

  } else {
    // Gather values
    const projectId = row.getAttribute("data-project-id");
    const archAssigned = archDropdown.value;
    const engrAssigned = engrDropdown.value;

    // Call backend
    fetch("/update_project_assignment", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        project_id: projectId,
        arch_assigned: archAssigned,
        engr_assigned: engrAssigned
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Disable dropdowns again
        archDropdown.disabled = true;
        engrDropdown.disabled = true;

        // Reset button to Edit
        button.textContent = "Edit";
        button.classList.remove("btn-success");
        button.classList.add("btn-primary");
      } else {
        alert("Error updating assignment: " + data.message);
      }
    })
    .catch(err => {
      console.error("Update failed:", err);
    });
  }
}
</script>


<!-- Assign Project to Employee Modal Ending -->


    <!-- Add Employee Modal -->
    <div class="modal fade" id="addEmployeeModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="addEmployeeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="addEmployeeModalLabel">Add an Employee</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <form id="addEmployeeForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="empName" class="form-label">Employee Name</label>
              <input type="text" class="form-control" id="empName" required>
            </div>

            <div class="col-md-6 mb-3">
              <label for="empEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="empEmail" required>
            </div>

            <div class="col-md-6 mb-3">
              <label for="empDesignation" class="form-label">Designation Code</label>
              <select class="form-select" id="empDesignation" required onchange="updateDesigName()">
                <option value="">-- Select Designation --</option>
                {% for desig in designations %}
                <option value="{{desig.desig_id}}" data-name="{{desig.desig_name}}">{{desig.desig_code}}</option>
                {% endfor %}
              </select>
            </div>

            <script>
                function updateDesigName(){
                    const select = document.getElementById("empDesignation");
                    const selectedOption = select.options[select.selectedIndex];
                    const desigName = selectedOption.getAttribute("data-name");

                    document.getElementById("empDesignationName").value = desigName || "";
                }
            </script>

            <div class="col-md-6 mb-3">
                <label for="empDesignationName" class="form-label">Designation Name</label>
              <input type="text" class="form-control" id="empDesignationName" disabled>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="empDOB" class="form-label">Date of Birth</label>
              <input type="date" id="empDOB" class="form-control" placeholder="Select DOB">
            </div>
            <div class="col-md-6 mb-3">
              <label for="empDOJ" class="form-label">Date of Joining</label>
              <input type="date" id="empDOJ" class="form-control" placeholder="Select DOJ">
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="empBranch" class="form-label">Branch</label>
              <select class="form-select" id="empBranch" required onchange="updateBranchName()">
                <option value="">-- Select Branch --</option>
                {% for branch in branches %}
                <option value="{{branch.branch_id}}" data-name="{{branch.branch_name}}">{{branch.branch_code}}</option>
                {% endfor %}
              </select>
            </div>

            <script>
                function updateBranchName(){
                    const select = document.getElementById("empBranch");
                    const selectedOption = select.options[select.selectedIndex];
                    const branchName = selectedOption.getAttribute("data-name");

                    document.getElementById("empBranchName").value = branchName || "";
                }
            </script>


            <div class="col-md-6 mb-3">

                <label for="empBranchName" class="form-label">Branch Name</label>
                <input type="text" class="form-control" id="empBranchName" disabled>

            </div>

          </div>

          <div class="mb-3">
            <label for="empUsername" class="form-label">Username</label>
            <input type="text" class="form-control" id="empUsername" required>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary" form="addEmployeeForm">Save Employee</button>
      </div>
    </div>
  </div>
</div>

<!-- Employee List Modal -->
<div class="modal fade" id="employeeListModal" tabindex="-1" aria-labelledby="employeeListModalLabel" data-bs-backdrop="static" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="employeeListModalLabel">Employee List</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <!-- Search -->
        <div class="row mb-3">
          <div class="col-md-4">
            <input type="text"
                  id="employeeSearch"
                  class="form-control"
                  placeholder="Search employee..."
                  list="employeeSuggestions"
                  onkeyup="filterEmployees()">

            <datalist id="employeeSuggestions"></datalist>

          </div>
        </div>

        <table class="table table-bordered table-striped table-hover align-middle" id="employeeTable">
          <thead class="table-dark">
            <tr id="headRow">
              <th id="selectAllTh" style="display:none;">
                <input type="checkbox" onclick="toggleAll(this)">
              </th>
              <th onclick="sortEmployeeTable(this)">Sr.No ‚¨ç</th>
              <th onclick="sortEmployeeTable(this)">Name ‚¨ç</th>
              <th onclick="sortEmployeeTable(this)">Date Of Joining ‚¨ç</th>
              <th onclick="sortEmployeeTable(this)">Date of Birth ‚¨ç</th>
              <th onclick="sortEmployeeTable(this)">Age ‚¨ç</th>
              <th onclick="sortEmployeeTable(this)">Email Address ‚¨ç</th>
            </tr>
          </thead>

          <tbody>
            {% for emp in employee_list %}
            <tr>
              <td class="selectTd" style="display:none;">
                <input type="checkbox" class="empCheckbox" value="{{ emp.name }}">
              </td>
              <td>{{ emp.SrNo }}</td>
              <td>{{ emp.name }}</td>
              <td>{{ emp.doj }}</td>
              <td>{{ emp.dob }}</td>
              <td>{{ emp.age }}</td>
              <td>{{ emp.email }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

      </div>

      <div class="modal-footer">
        {% if session['user_category'] == 'SuperAdmin' %}
        <button class="btn btn-danger" id="inactiveBtn" onclick="enableInactiveMode()">Mark as InActive</button>
        <button class="btn btn-warning d-none" id="confirmInactiveBtn" onclick="confirmInactive()">
          Confirm InActive
        </button>
        <button class="btn btn-outline-secondary d-none" id="exitInactiveBtn" onclick="exitInactiveMode()">
          Exit Inactive Mode
        </button>
        {% endif %}
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>




    </div>

    <script>
      //Exit Inactive Mode...///...//
      function exitInactiveMode() {
        inactiveMode = false;

        // Hide checkbox column
        document.getElementById("selectAllTh").style.display = "none";

        document.querySelectorAll(".selectTd").forEach(td => {
          td.style.display = "none";
        });

        // Reset all checkboxes
        document.querySelectorAll(".empCheckbox").forEach(cb => {
          cb.checked = false;
        });

        // Reset buttons
        document.getElementById("inactiveBtn").classList.remove("d-none");
        document.getElementById("confirmInactiveBtn").classList.add("d-none");
        document.getElementById("exitInactiveBtn").classList.add("d-none");
      }
      //Setting Users Inactive....////
      let inactiveMode = false;

      function enableInactiveMode() {
        inactiveMode = true;

        document.getElementById("inactiveBtn").classList.add("d-none");
        document.getElementById("confirmInactiveBtn").classList.remove("d-none");
        document.getElementById("exitInactiveBtn").classList.remove("d-none");

        document.getElementById("selectAllTh").style.display = "";

        document.querySelectorAll(".selectTd").forEach(td => {
          td.style.display = "";
        });
      }

      function toggleAll(source) {
        document.querySelectorAll(".empCheckbox").forEach(cb => {
          cb.checked = source.checked;
        });
      }

      function confirmInactive() {
        const selected = [];

        document.querySelectorAll(".empCheckbox:checked").forEach(cb => {
          selected.push(cb.value);
        });

        if (selected.length === 0) {
          alert("Please select at least one employee.");
          return;
        }

        if (!confirm("Are you sure you want to mark selected employees as inactive?")) {
          return;
        }

        console.log(selected);

        // üî• SEND TO BACKEND
        fetch("/mark_employee_inactive", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ employees: selected })
        })
        .then(res => res.json())
        .then(data => {
          alert(data.message);
          location.reload();
        })
        .catch(err => {
          alert("Error updating employees");
          console.error(err);
        });
      }
      /* ---------------- SEARCH FILTER ---------------- */
      function filterEmployees() {
        const input = document.getElementById("employeeSearch").value.toLowerCase();
        const table = document.getElementById("employeeTable");
        const rows = table.tBodies[0].rows;

        for (let row of rows) {
          let match = false;
          for (let cell of row.cells) {
            if (cell.innerText.toLowerCase().includes(input)) {
              match = true;
              break;
            }
          }
          row.style.display = match ? "" : "none";
        }
      }

      /* ---------------- AUTOCOMPLETE ---------------- */
      function loadEmployeeSuggestions() {
        const datalist = document.getElementById("employeeSuggestions");
        datalist.innerHTML = "";

        const table = document.getElementById("employeeTable");
        const rows = table.tBodies[0].rows;
        const values = new Set();

        for (let row of rows) {
          values.add(row.cells[2].innerText.trim()); // Name
        }

        values.forEach(val => {
          const option = document.createElement("option");
          option.value = val;
          datalist.appendChild(option);
        });
      }

      /* ------------- RESET ON MODAL OPEN ------------- */
      document.getElementById('employeeListModal')
        .addEventListener('shown.bs.modal', () => {
          document.getElementById("employeeSearch").value = "";
          filterEmployees();
          loadEmployeeSuggestions();
        });
    </script>


    <!-- Employee Table Sorting -->
    <script>
      let employeeSortDir = {};

      function sortEmployeeTable(th) {
        const table = document.getElementById("employeeTable");
        const tbody = table.tBodies[0];
        const rows = Array.from(tbody.rows);

        // Get exact column index from header row
        const headers = Array.from(th.parentElement.children);
        const colIndex = headers.indexOf(th);

        // Do not sort checkbox column
        if (th.id === "selectAllTh") return;

        // Toggle direction
        const dir = employeeSortDir[colIndex] === "asc" ? "desc" : "asc";
        employeeSortDir[colIndex] = dir;

        rows.sort((a, b) => {
          if (!a.cells[colIndex] || !b.cells[colIndex]) return 0;

          let valA = a.cells[colIndex].innerText.trim();
          let valB = b.cells[colIndex].innerText.trim();

          // DOJ / DOB
          if (colIndex === 3 || colIndex === 4) {
            valA = new Date(valA);
            valB = new Date(valB);
          }
          // Age
          else if (colIndex === 5) {
            valA = parseInt(valA) || 0;
            valB = parseInt(valB) || 0;
          }
          // Number
          else if (!isNaN(valA) && !isNaN(valB)) {
            valA = Number(valA);
            valB = Number(valB);
          }
          // String
          else {
            valA = valA.toLowerCase();
            valB = valB.toLowerCase();
          }

          if (valA < valB) return dir === "asc" ? -1 : 1;
          if (valA > valB) return dir === "asc" ? 1 : -1;
          return 0;
        });

        rows.forEach(row => tbody.appendChild(row));
      }
      </script>




<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
function openTaskModal(taskId) {
    // Store the task ID in the hidden field
    document.getElementById("modal_task_id").value = taskId;

    // Optionally, prefill description and remarks
    const taskDescElement = document.getElementById("task_description_" + taskId);
    const remarksElement = document.getElementById("remarks_" + taskId);

    const modalTaskHistory = taskDescElement.value.split('|') || taskDescElement.innerText.split('|');
    const remarksHistory = remarksElement.value.split('|') || remarksElement.innerText.split('|');

    console.log(modalTaskHistory)

    let taskModalLabel = "Task Update History: <br />";
    let remarksModalLabel = "Remarks Update History: <br />";

    modalTaskHistory.forEach((elem,index) => taskModalLabel += elem+"<br />");
    remarksHistory.forEach((elem,index) => remarksModalLabel += elem+"<br />");


    document.getElementById("taskModalLabel1").innerHTML = taskModalLabel;
    document.getElementById("taskModalLabel2").innerHTML = remarksModalLabel;

    // Show the modal
    const myModal = new bootstrap.Modal(document.getElementById('taskUpdateModal'));
    myModal.show();
}

function submitTaskUpdate() {
    const taskId = document.getElementById("modal_task_id").value;
    const taskDesc = document.getElementById("taskUpdateText").value;
    const remarks = document.getElementById("taskRemarks").value;

    fetch("/update_assigned_tasks", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            task_id: taskId,
            task_desc: taskDesc,
            remarks: remarks
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === '200') {
            alert(data.message);

            // Optionally refresh or update UI
            location.reload(); // reload to reflect changes
        } else {
            alert("Update failed.");
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Something went wrong!");
    });
}
</script>

<script>
function openReviewModal(taskId) {
    // Store the task ID in the hidden field
    document.getElementById("modal_task_id").value = taskId;

    // Optionally, prefill description and remarks
    const taskDescElement = document.getElementById("task_description_" + taskId);
    const remarksElement = document.getElementById("remarks_" + taskId);

    console.log(taskDescElement);
    console.log(remarksElement);

    document.getElementById("revieUpdateLabel").innerText = taskDescElement ? taskDescElement.value || taskDescElement.innerText : '';
    document.getElementById("reviewRemarks").placeholder = remarksElement ? remarksElement.value || remarksElement.innerText : '';

    // Show the modal
    const myModal = new bootstrap.Modal(document.getElementById('reviewUpdateModal'));
    myModal.show();
}

function submitReviewUpdate() {
    const taskId = document.getElementById("modal_task_id").value;
    const taskDesc = document.getElementById("reviewUpdateText").value;
    let remarks = document.getElementById("reviewRemarks").value;
    const status = document.getElementById("status_update").value;

    remarks = remarks+" (Edit): "+". Task Has Been "+status;

    fetch("/update_task_under_review", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            task_id: taskId,
            task_desc: taskDesc,
            remarks: remarks,
            task_status : status
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === '200') {
            alert(data.message);

            // Optionally refresh or update UI
            location.reload(); // reload to reflect changes
        } else {
            alert("Update failed.");
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Something went wrong!");
    });
}
</script>

<!-- Admin Panel Modals Script -->
<script>
    document.addEventListener("DOMContentLoaded", function(){
        document.getElementById("addProjectForm").addEventListener("submit", function(e) {
        e.preventDefault();

        const projectCode = document.getElementById("projectCode").value;
        const clientName = document.getElementById("clientName").value;
        const clientAddr = document.getElementById("clientAddr").value;
        const clientContactInfo = document.getElementById("clientContactInfo").value;
        const remarks = document.getElementById("remarks").value;
        const projectName = document.getElementById("projectName").value;
        

        fetch("/add_project", {
            headers: {"Content-Type":"application/json"},
            method: "POST",
            body: JSON.stringify({
                project_code : projectCode,
                project_name : projectName,
                clientName : clientName,
                clientAddr : clientAddr,
                clientContactInfo : clientContactInfo,
                remarks : remarks
            })
        }).then((res) => res.json())
        .then((data) => {
            alert(data.message || "Project Saved Successfully..")
            if(data.status === 200){
                location.reload();
            }
        }).catch((err) =>{
            console.error(err)
            alert("Something went wrong during saving the project.")
        })


    })

    });

</script>
<!-- Employee Addition Script -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("addEmployeeForm").addEventListener("submit", function (e) {
        e.preventDefault();

        // Collect values
        const empName = document.getElementById("empName").value;
        const empEmail = document.getElementById("empEmail").value;
        const empDesignation = document.getElementById("empDesignation").value; // desig_id
        const empDesignationName = document.getElementById("empDesignationName").value;
        const empBranch = document.getElementById("empBranch").value; // branch_id
        const empBranchName = document.getElementById("empBranchName").value;
        const empUsername = document.getElementById("empUsername").value;
        const emp_dob = document.getElementById("empDOB").value;
        const emp_doj = document.getElementById("empDOJ").value;

        // Prepare payload
        const formData = {
            name: empName,
            email: empEmail,
            designation_id: empDesignation,
            designation_name: empDesignationName,
            branch_id: empBranch,
            branch_name: empBranchName,
            username: empUsername,
            empDOB : emp_dob,
            empDOJ : emp_doj
        };

        console.log("Form Data:", formData); // Debugging

        // Example: Send to backend (adjust URL to your route)
        fetch("/add_employee", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}" // if you're using Django/Flask-WTF, else remove
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            console.log("Server Response:", data);
            alert("Employee saved successfully!");
            // Optionally reset form
            document.getElementById("addEmployeeForm").reset();
            document.getElementById("empDesignationName").value = "";
            document.getElementById("empBranchName").value = "";
        })
        .catch(error => {
            console.error("Error:", error);
            alert("Failed to save employee.");
        });
    });
});
</script>


<script>
            function editRecord(task_id) {
                //$('#task_description_'+task_id).removeAttr('disabled');
                const task_desc = document.getElementById('task_description_'+task_id)
                

                task_desc.attributes.disabled = false;
                console.log(task_desc);
                task_desc.removeAttribute('disabled');

                console.log(task_desc)

                //document.getElementById("task_description_" + task_id).ariaReadOnly = false;
                document.getElementById("remarks_" + task_id).disabled = false;
                document.getElementById("save_" + task_id).style.display = "inline-block";
                //document.getElementById("edit_" + task_id).style.display = "none";
            }

            function saveStatus(task_id) {
                let new_task_description = document.getElementById('task_description_'+task_id).value;
                let new_remarks = document.getElementById('remarks_'+task_id).value;
                let status = document.getElementById('status_'+task_id).value;

                fetch("/update_assigned_tasks", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        task_id: task_id,
                        task_desc: new_task_description,
                        remarks: new_remarks
                        //status: status
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        alert(data.message);
                        document.getElementById("remarks_" + task_id).innerText = data.updated_remarks;
                        document.getElementById("status_" + task_id).disabled = true;
                        document.getElementById("save_" + task_id).style.display = "none";
                        document.getElementById("edit_" + task_id).style.display = "inline-block";
                    } else {
                        alert("Error: " + data.error);
                    }
                })
                .catch(error => console.error("Error:", error));
            }
</script>
</body>
</html>
